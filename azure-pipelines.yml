# Azure Pipeline for Reqnroll BDD Selenium Tests
# This pipeline builds and runs automated tests for the BDDselenium project

trigger:
  branches:
    include:
      - main
      - develop
      - feature/*
  paths:
    exclude:
      - README.md
      - '*.md'

pr:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: 'windows-latest'  # Using Windows for better Chrome/Selenium compatibility

variables:
  buildConfiguration: 'Release'
  solution: '**/*.sln'
  dotnetVersion: '8.0.x'
  TF_BUILD: 'true'  # Explicitly set CI environment variable
  CI: 'true'

stages:
  - stage: Build
    displayName: 'Build and Test'
    jobs:
      - job: BuildAndTest
        displayName: 'Build and Run Tests'
        steps:
          # Install .NET SDK
          - task: UseDotNet@2
            displayName: 'Install .NET SDK $(dotnetVersion)'
            inputs:
              packageType: 'sdk'
              version: '$(dotnetVersion)'
              installationPath: $(Agent.ToolsDirectory)/dotnet

          # Display .NET version
          - script: dotnet --version
            displayName: 'Display .NET version'

          # Display Chrome version (for debugging)
          - task: PowerShell@2
            displayName: 'Display Chrome version'
            continueOnError: true
            inputs:
              targetType: 'inline'
              script: |
                Get-Command chrome -ErrorAction SilentlyContinue
                Get-ItemProperty 'HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\Google Chrome' -ErrorAction SilentlyContinue | Select-Object DisplayVersion

          # Restore NuGet packages
          - task: DotNetCoreCLI@2
            displayName: 'Restore NuGet packages'
            inputs:
              command: 'restore'
              projects: '$(solution)'
              feedsToUse: 'select'

          # Build the solution
          - task: DotNetCoreCLI@2
            displayName: 'Build solution'
            inputs:
              command: 'build'
              projects: '$(solution)'
              arguments: '--configuration $(buildConfiguration) --no-restore'

          # Run tests
          - task: DotNetCoreCLI@2
            displayName: 'Run Reqnroll/Selenium tests'
            inputs:
              command: 'test'
              projects: '$(solution)'
              arguments: '--configuration $(buildConfiguration) --no-build --logger "console;verbosity=detailed" --logger trx --results-directory $(Build.SourcesDirectory)/TestResults'
            continueOnError: true  # Continue even if tests fail to publish results

          # Publish test results
          - task: PublishTestResults@2
            displayName: 'Publish test results'
            inputs:
              testResultsFormat: 'VSTest'
              testResultsFiles: '**/TestResults/*.trx'
              searchFolder: '$(Build.SourcesDirectory)'
              mergeTestResults: true
              failTaskOnFailedTests: false  # Don't fail the pipeline on test failures, just report them
              testRunTitle: 'Reqnroll BDD Tests'
              publishRunAttachments: true
            condition: succeededOrFailed()

          # Publish build artifacts (optional)
          - task: PublishBuildArtifacts@1
            displayName: 'Publish build artifacts'
            condition: succeededOrFailed()
            inputs:
              PathtoPublish: '$(Build.SourcesDirectory)/ReqnrollTestProject/bin/$(buildConfiguration)'
              ArtifactName: 'drop'
              publishLocation: 'Container'
